% thinks to bear in mind
% reader must be able to reproduce it

\section{Augmenting the 3D building estimate}
\subsection{Introduction}
% write THIS AT LAST
In the previous section we saw the equivalence between the skyline and the building contour, we also saw how this skyline was detected and how every point on this skyline was projected on the buildingwall it most likely presents. 
This 3D pointcloud may give an interesting first impressive but it is not enough for our aim, to augment the basic 3D model.
First of all this pointcloud included a lot of noise caused mostly by occluding objects like tree's. How do we detect those outliers?
% why not ransac?
And if we know which data belongs to the building contour and which not how can we use our developed projection techniques to obtain parts of the building contour.
The next question arises is, given this building contour parts, how do we augment the 3D model in a clean way?
To adress these questions an sophisticated algorithm is developed.

%before we take these next steps we take one step back and go to the 2d images.
	%we saw that the skyline detector outputs a binary image where a white pixel is considered as highly from the skyline and therefor the building contour.
	%todo
\subsection{The algorithm}
Let us first define the input of the algorithm:
\begin{itemize}
\item a set of calibrated binary 2D images where white indicates a skyline pixel which has a high proability of being the building contour
\item a rough 3D model
\end{itemize}
The output will be an updated 3D model, this output is developed in several steps.\\
First some operation are done in 2D, the individual skyline pixels are grouped into line segments using an approach called the Hough transform. In the next step every line is heuristicly associated to and projected on a specific wall in 3D. The third step is to combine the projected line segments, which produces and estimate of the height of each buildingwall. In the last step these heights are used to augment the walls of the rough 3D model.
We will now elaborato on each step.

%why fit lines on 2d and not in 3d
%cheaper easyer?
\subsubsection{Extracting line segments, Hough transform} % Houghlines
	%The aim of this step is to use the output of the skyline detector to extract line segments. These line segments can be used to update to indicate the building contour and update the 3D model.

	%chaining my ass of here :)
	% full motivation 
	The main aim of this part is to take the output of the skyline detector and to remove its outliers caused by for example tree's. To remove the outliers we put the process upside down: we detect the inliers.
	But how do we know wat an inlier is?
	If we take the contour of an average building it is mostly formed by straight lines.
	% todo example images
	So if a bunch of skyline pixels lie on the same line it is probably a building countour.
	% TODO what if a plain flys by? note in drawbacks of method
	The problem of finding the building contour is now boiled down to finding skyline pixels that form a straight line.

	%Note that this is based on a flat roof assumption which will be elaborated in the update 3D model part.
	\\
	A famous method for extracting line segments is the the Hough transform invented by Paul Hough.
	We will explain this method in short, details regarding this method are found in the Appendix.A??%TODO
	In the Hough transform, a main idea is to consider the characteristics of a straight line not as its image points $(x1, y1)$, $(x2, y2)$, etc., but in terms of the parameters of the straight line formula $y = mx + b$. i.e., the slope parameter $m$ and the intercept parameter $b$.
	If a skylinepixel is found the Hough transform increases a vote value for every line ($m$,$b$ pair) that crosses this point.
	The lines ($m$, $b$ pairs) that receive a large amount of votes and are likely to represent a line segment and therefor a part of the building contour.
	\\
	The Houghtransform is done on the 2D output of the skyline detector. Results are displayed and evaluated in the result section.
	% details in appendix

\subsubsection{Heuristic Line-Wall determination}
	% what do we have what is the input
	Now we have a bunch of 2D line segments which represent parts of the building contour. 
	As we agreed in our assumption every line segment is originated from a upperside of a wall of the building.
	It looks like its time to augment these walls but in fact we don't know which linesegments is associated with which wall.

%------------------------------------------------------------------------------------------------

	To determine which wall the linesegment belongs to it would be straightforward to use the method of section %TODO
	but take instead of of a skyline pixel only the linesegments endpoints and project it onto the building.

	And to update the specific wall we first need to know with a high probability of being correct which wall the line segment presents
	
	%As can be seen in the previous section determining on which part of the building a skyline pixel belongs quite succesfull.
	But this introduces a little problem: some of the line segments have endpoints of the corner of the building.
	The linesegments endpoint on this corner could easily be classified as the ascending wall.
	The wall is now undetermined because both endpoints do not agree on the same wall.  
	To solve this problem some heuristic methods are developed and tested.
	% todo explain?
	%A heuristic is succesfull if it is simple and effective.
	The middle point of the line segment has a low change of being on a buildingcorner and a big change of being on the wall we are looking for.
	Therefor we use the middlepoint instead of the endpoints to determine the right wall.
	As in the previous section %TODO
	this middlepoint is intersected with all plaines spanned by the walls. The linesegment is stored to the wall with the shortest distance.
	%The output of this part of the algorithm is for every wall a bunch of associated linesegments originated from different views.
	\\
	Now all line segments are associated with a certain wall we can use this information to augment the 3D model.
	Before we do this we assume that every wall has a straight upperside. % TODO is dit niet al een kkeertje aangenomen jongu?
	% TODO hoezo?
	The last step for augmenting the buildinging, bearing this assumption in mind, is now boiled down to making a good estimate of the height of the wall of the building.

	%The middle point is used as a third candidate for voting oh yeah i love to vote men i love
	% I LOVE NIG GERNS I LOVE NIG RS
	
	% chaining
	%example image


	%decide which line segment represents which wall (heuristic)
\subsubsection{Wall height estimation}

	%calc average height of lines for each wall
	% update belonging wall
	In the previous section we adressed the problem that the endpoints of a line segment may not agree on the wall.
	We also introduced a method to determine the right wall.  
	Next we reproject the line segment to that wall.
	The reprojection is done by intersecting both endpoints of the linesegment to the plane that is spanned by this wall.
	This is done for every linesegment belonging to the wall we process. 
	Next the 3D intersection points are collected and averaged, this gives us an average of the midpoints of the projected linesegments.
	This value is used as the new height of the wall of the building.
	Above process is done for every wall.
	
	%The coordinates of the projected endpoints are stored with the corresponding wall.
	%This gives the following result?
	%TODO image

\subsubsection{Augmenting the 3D model} %todo other word then augment?
	%We make a flatroof assumption assuming that a building consists of a flat roof (note that the walls may have different heights but the roof should be flat).

%flatroofassumption
	%we make an assumption that a building contour is appears to be as a bunch of skylinepixel on a straight line.
%flatroofassumption
%TODO cons pros of this assumption
%TODO vet goed dat ik dus mijn algo different wallheights aan kan, promoten!


	% check in code how this is done?
	The rough 3d model is divided in different walls. A wall exist of four corner points. In the previous section we calculated the new heights of the walls the building. This is propagated by adjusting the upper cornerpoints of walls.
	This is done by coping the bottomleft and right cornerpoints and adding the estimated height from the previous section to the y-value.
	Note that this method assumes that the walls are alligned on the y-axis, which is in our dataset the case.
	%TODO iets zeggen over het ground plain, zie ook costins werk


\subsection{Results (What did I find)}
\subsection{Discussion (What do my results mean to me and why)}
\subsection{Conclusion and Future work}
The flat roof assumption could be stretched to a roof consist of two planes
\\
The middle point of the line is projected to all walls, it could be a significant speedup to reduce the set of walls to only the walls that are found at the endpoints. This is not done because both endpoints could lie on a cornerpoint making it possible that none of the endpoints refer to the correct wall.


%idea to think of (to detailed or not):
program and test different heuristics?
do analytic test (compare 1 and 3 analyticly)
	to much detail for something like this? or not?

Plan:
first write thesis without the heuristic part

IDEAS:
heuristic 1:
take a point in the middle and let it decide

heuristic 2:
the endpoint that lies more in the middle decides which wall we take
this can be calculated using the difference of distances to the wall corner points

heuristic 3:
take points on a houghline
make a rating that the more in a middle a point is the more evidence there is
this is because it is more away from a corner so lower change of other wall


% TODO
what to do with outliers
where to put the intersection algorithm part
for now i let it in skyline detection and refer to it
maybe later move it!
%TODO what are the mathematics
%TODO write something about complications and wat je er aan hebt
%what are the assumptions and heuristics
%use power of illustration, lots of example images! ask myself is there stil something left where I can add an illustration??



