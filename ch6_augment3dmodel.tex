\documentclass[10pt]{article}
\usepackage{graphicx, subfigure}

\usepackage{amsmath} % for the argmin
\newcommand{\argmax}[1]{\underset{#1}{\operatorname{argmax}}}
\newcommand{\argmin}[1]{\underset{#1}{\operatorname{arg\ min}}}
\setlength{\parindent}{0in}
\include{commands}

\title{\sc Optimizing 3D models from 2D images}

\author{T. Kostelijk\\mailtjerk@gmail.com}

\begin{document}
\maketitle


\section{Augmenting the 3D building}
\subsection{Introduction}
% write THIS AT LAST
In the previous section we saw the equivalence between the skyline and the building contour, we also saw how this skyline was detected and how every point on this skyline was projected on the building wall it most likely presents. 
This 3D point cloud is an interesting result but it is not enough for our aim, to augment the basic 3D model.
First of all this point cloud included a lot of noise caused mostly by occluding objects like tree's. How do we detect those outliers?
% why not ransac?
And if we know which data belongs to the building contour we could use the developed projection techniques from section %TODO
to obtain parts of the building contour.
The next question arises is, given this building contour parts, how do we augment the 3D model in a clean way?
We developed an algorithm that addresses these questions.
%before we take these next steps we take one step back and go to the 2d images.
	%we saw that the skyline detector outputs a binary image where a white pixel is considered as highly from the skyline and therefor the building contour.
	%todo
\subsection{The algorithm}
Let us first define the input of the algorithm:
\begin{itemize}
	\item a set of calibrated binary 2D images where white indicates a skyline pixel which has a high probability of being the building contour
	%TODO explain calibrated somewhere eerder in het report
	\item a rough 3D model extracted from an open street view database
	%TODO introduce the 3D model somewhere eerder in report
\end{itemize}
The output will be an updated 3D model, this output is developed in several steps:\\
First some operation are done in 2D, the individual skyline pixels are grouped into line segments using an approach called the Hough transform. In the next step every line is heuristicly associated to (and projected on) a specific wall in 3D. The third step is to combine the projected line segments, which produces and estimate of the height of each building wall. In the last step these heights are used to augment the walls of the rough 3D model.
We will now elaborate on each step.

%why fit lines on 2d and not in 3d
%cheaper easier?
\subsubsection{Extracting line segments, Hough transform} % Houghlines
	%The aim of this step is to use the output of the skyline detector to extract line segments. These line segments can be used to update to indicate the building contour and update the 3D model.

	%chaining my ass of here :)
	% full motivation 
	The main aim of this part is to extract structure from the output of the skyline detector. This includes the removement of outliers (caused by for example an occluding tree) and the extraction of straight line segments. 
	To remove the outliers we put the process upside down: we are detecting the inliers and consider the rest as outliers.\\
	But do we define an inlier? If we take the contour of an average building it is mostly formed by straight lines, assuming the roof is flat.
	% todo example images
	If a bunch of skyline pixels lie on the same line they probably represent a building contour.
	% TODO what if a plain flys by? note in drawbacks of method
	The problem of finding the building contour is now boiled down to finding skyline pixels that lie on a straight line.
	\\
	A famous method for extracting line segments is the the Hough transform (invented by Paul Hough).
	We will explain this method in short, details regarding this method are found in the Appendix.A??%TODO
	In the Hough transform, a main idea is to consider the characteristics of a straight line not as its image points $(x1, y1)$, $(x2, y2)$, etc., but in terms of the parameters of the straight line formula $y = mx + b$. i.e., the slope parameter $m$ and the intercept parameter $b$.
	If a skyline pixel is found the Hough transform increases a vote value for every valid line ($m$,$b$ pair) that crosses this particular point. This is done in a very efficient way, see Appendix A?? %TODO 
	for details.
	The lines ($m$, $b$ pairs) that receive a large amount of votes contain a large amount of skyline pixels. Because it is a straight line it most likely represents a part of the building contour. 
	Optional the Hough transform returns the start- and endpoint of the lines which is in our case useful. 
	%Because of occlusion the Houghlines could return two separate line segments which is originally one line which is %onderroken.
	\\
	Results of the Hough transform on the 2D output of the skyline detector are displayed and evaluated in the result section (section %TODO
	).

\subsubsection{Heuristic Line-Wall determination}
% 	method below is very nice but it is outperformed by my ultragenius other
% 	method, so I could use it in the thesis but only as different test
% 	methods
%
% 	It would be straightforward to use the method of chapter %TODO
% 	Instead of a skyline pixel we could take the line segments endpoints and project it onto the building walls. The wall with the shortest distance will be assigned to the line segment.
% 
% 	%And to update the specific wall we first need to know with a high probability of being correct which wall the line segment presents
% 	But this method introduces a problem: some of the line segments have endpoints that lie at the corner of the building. These line segments could easily be associated with the neighboring wall. Because the 3D model is a rough estimate this could lead to bad results.
% 	In the corner case it is not clear to which wall the line segment belongs because both endpoints do not agree on the same wall. To solve this problem some heuristic methods are developed and tested. The following heuristic is both simple and effective.
% 	The heuristic uses the importance of the middle point of the line segment. This middle point has a low change of being on a building corner and the on average biggest change of being on the wall we are looking for.
% 	Therefor we discard the endpoints and use the middle point the endpoints to determine the right wall.
% 	As in the previous section %TODO
% 	this middle point is intersected with all planes spanned by the walls. The line segment is stored to the wall with the shortest distance.
% 	The output of this part of the algorithm is for every wall a bunch of associated line segments originated from different views.
% 
% 	%TODO example image

	The Hough transform returned a set of 2D line segments. We assume this set
	represent (parts of) the building contour. To be more precise we assume
	that every line segment in the set represents (a part of) the upper side of
	a wall of the building. This section explains how we, given a line
	segment, determine its associated wall.

	%TODO name different methods and put in table and test
	% Some different methods
	% method 1:
	% take endpoints and project, con: endpoints don't agree
	% see above tekst
	% method 2:
	% midle point
	% method 3: 
	% overlap
	
	% structure is?
	% -situation
	% -method
	% -concl

	Before we expain the method the situation is analysed.

	% TODO uitzoeken hoe je R noteert
	Lets define $l$ in $R2$ as a line segment that is generated by the Hough transform.
	If we project $l$ to the plane spanned by a certain wall $w$, we get a line $l_{proj_w}$ in $R3$.
	If $l$ comes from the contour of wall $w$, then $l_{proj_w}$ should have
	a large overlap with $w$, and have small overlap with the other walls.
	%see figure%TODO.
	To be more precice, we asume that a line segment always represents a building contour and
	that this line segment is originated from the wall where the projected
	line segment has the largest overlap with.
	%TODO (disadvantage unique wall asumption: line loopt door verschillende walls)

	The algorithm can be described broadly as follows:
	A line segment is projected to all walls and the amount of line-wall overlap is
	calculated. The wall with the largest overlap with the specific line
segment is classified as the most likely wall for that line segment.
	Next the line segments are projected to their most likely wall, the
	algorithm outputs this set of lines in $R3$. 
	
	The line-wall overlap is calculated in different steps.
	First the type of overlap is determined, next the amount of overlap is
	determined and last the overlap is normalised. These steps are now
	explained.

	Next is explained how $lwo$ is calculated.
	The first step in calculating $lwo$ a specific \emph{overlaptype} is
	determined.\\
	$l_{proj_w}$ can overlap $w$ in four different scenarios:
		1) no overlap (see fig %TODO)
		2) partial overlap (fig %TODO)
		3) full overlap ($l_{proj_w}$ is included in $w$)(fig %TODO)
		3) full overlap ($l_{proj_w}$ overextends $w$) (fig %TODO)
	%TODO table?, overlap, points in polygon, output value (e.g. partial overlap, 1, 0..1)
	% in figure overlap ratio percentages drawwen

	\paragraph{Line wall overlap type}
	The type of overlap is defined by exposing the endpoints of the line
	segments to an \emph{in polygon} test where the polygon is a certain
	wall of the building.
	%TODO REF MATLAB?
	%we use the Matlab build in polygon as in section (%TODO)
	\begin{tabular}
	Type of line-wall overlap 			&	points in polygon 			& line-wall overlap \\
	no overlap					&	0					& 0		\\
	partial overlap 				&	1					& <0..1>	\\
	full line-wall overlap (included)		&	2					& 1		\\
	full line-wall overlap (overextended)		&  	0					& 1 		\\
	\end{tabular}
	% TODO uitzoeken wat interval t/m is 

	Table %TODO
	represents the types of overlap with the corresponding number of points
	that pass the \emph{in polygon} test with their line-wall overlap value (interval).

	If the point in polygon test returns 0 the line-wall overlap calculation
	is skipped and 0 is returned. The remaining overlap types (partial- and full
	line-wall) overlap are calculated differently.
	Lets first consider the partial overlap type, the \emph{in polygon} test
	returned 1, that means that one of the line segments endpoint lies in
	and one lies outside the wall.
	To calculate its line-wall overlap, the line needs to be cut down to the
	part that overlaps the wall. Its easy to see that this point is defined
	as the intersection of the line with one of the vertical wall sides, see
	figure. %TODO
%. The cutdown line has two coordinates, first ofcourse the point that passed
%the \emp{in polygon} test and second the intersection of the original line with
%one of the vertical wallsides
	%Because we assume infinite height, The partial overlapping line always intersects one of the vertical wallsides.
	%The overlapping part of the line is the linesegment defined by this intersection and the line segments endpoint that succeeded the in polygon test.
	To determine which of the two vertical lines $ad$ or $bc$ from Figure
	%TODO
	 is crossed, a simple angle comparison (as in section %TODO) is done.
	First, four vectors are calculated connecting $w$, $d$, and $c$, see figure %TODO.
	One of the angles between vectors pair ($dc$, $dw$) and ($cd$, $cw$) are
	obtuse, as one of the line segment endpoints lies outside the wall. 
	(Note that the assumption is made that all wall sides are orthogonal)\\
	%TODO angle tekentje 
	If $\angle dc, dw$ is obtuse, the left vertical wallside $da$, is
	crossed. \\
	If $\angle cd, cw$ is obtuse, the right vertical wallside $cb$, is
	crossed. \\
	The line-wall overlap is now easily calculated by cutting of the
	point where $l$ intersects the determined vertical wallside ($da$ or
	$cb$) and measuring its remaining length.


	Now lets consider the overlap type where the \emp{in polygon} test
	returned 0.
	As you can see in Figure %todo
	this could be either full or none overlap.

	This is determined again by analysing the vector angles.
	Lets consider 
	figure %TODO
	and figure %TODO
	, both angles $\angle dv, dc$ and $\angle dw,dc$ are obtuse or acute
	because the linesegment lies outside the wall. An overlap value of zero
	is returned.\\
	Otherwise, if $\angle dv, dc$ and $\angle dw,dc$ differ in obtuse or accuteness
	(e.g. $\angle dv, dc$ is acute but $\angle dw, dc$ is obtuse), 
	both endpoints lie on a different side of the wall and full overlap is
	concluded. This amount of overlap is calculated by measuring the length
	of the line segment defined by the intersections with $da$ and $cb$ and
	the line segment $vw$.
	
	To summarize the overlap type is defined by calculating orthogonality
	from some angles 
	Remark that the angles are acute or obtuse if the dot product of the vectors involved are
	respectively positive or negative. The advantage of this method is that
	its simple and computational cheap.
	

	
	%chain the mofo!
	Finally the line-wall overlap is normalised by the line segments length:\\
	$\alhpa_{l} = \fac{lwo}{|l|}$
	$\alpha_{l}$ is the normalised line-wall overlap, 
	$lwo$ is the unnormalised amount of line-wall overlap, 
	and ($|l|$) is the total length of the line sement.\\

	The intuition behind this is that line segments that are likely to
	present a wall not only have a large overlap but also have a small part
	that has no overlap. By calculating the relative overlap, both amount of overlap
	and -missing overlap is taken into account.\\


	The maximum of the normalised line-wall overlap is used to associate a
	line segment with his most likely wall.
	%TODO formula?
	\textemph{should I place a formula here? and if yes what kind of
	notation do I use, and which subscripts?}

	Next the line segments are projected to these most likely walls. This
	set of lines ($R3$), indexed on their associated walls, are used for the
	next step.


	% TODO:
	% make schema with 3 methods, and in one regel the summary of its technique
	
	% test with different techniques
	% make different dataset
	% hand anotated (pleonastisch zeg hehe) for ground truth
	% 1) project endpoints (and sometimes end up not agreeing wall)
	% 2) use midpoint of line
	% 3) use tjs algo (line wall overlap)

\subsubsection{Wall height estimation}
	%TODO CHAINING AGAIN
%	In the previous section we addressed the problem that the endpoints of a line segment may not agree on the wall.  We also introduced a method to associate a line segment with the right wall. 
  	In the previous section we associated the line segments with their most
	likely wall.
	In this section this information is used to estimate the height of the
	wall which is finally used to update the 3D model in section %TODO
	\\
	Now all line segments are associated with a certain wall we re-project the line segment from the different views on the wall. The re-projection is done by intersecting both endpoints of the line segment to the plane that is spanned by associated wall.
	Next the 3D intersection points are collected and averaged, this gives us an average of the midpoints of the projected line segments. We do this for every wall separately returning the average height of the line segments.
	These averages are then used as the new heights of the walls of the building.

\subsubsection{Augmenting the 3D model} %todo other word then augment?
	We made an assumption that a building consists of a flat roof (note that the walls may have different heights but the roof should be flat).
	In the previous section we calculated the new individual heights of the walls the building. 
	This is propagated to the 3D model by adjusting the location of the existing upper corner points of the walls. We copy the bottom left and -right corner points and add the estimated height from the previous section to its y-value.
	FOOTNOTE:Note that this method assumes that the walls are aligned on the y-axis, which is in our dataset the case.
	% TODO footnote: 
	%TODO iets zeggen over het ground plain, zie ook costins werk

	

\subsection{Results}
\fig{outputSkylineIm3-3.eps}{}{0.5}
Lets rehearse the output of the skyline detector in figure \ref{fig:outputSkylineIm3-3.eps}.
\fig{outputHoughlines2d.eps}{}{0.5}
\fig{outputHoughlines3d.eps}{}{0.8}
\fig{outputMutateBuilding.eps}{}{0.7}
Figure \ref{fig:outputHoughlines2d.eps} shows the top 3 longest Houghlines, the
endpoints are denoted with a black and blue cross. All three lines lie on the
building contour.  The left line covers only a part of the building wall. The
middle line covers the full wall. The left and middle line are connected. The
right line covers the wall until the tree occludes.\\

Figure \ref{fig:outputHoughlines3d.eps} displays the line segments (originated from
different views) projected onto their associated walls.  For a clear view we
only selected the lines that where associated with three specific walls of the building.  
The red cross in the middle of the line is representing the average of its endpoints.\\

Figure \ref{fig:outputMutateBuilding.eps} displays the augmented 3D model. The
corner points of the walls are adjusted according the calculated wall heights.
The green plane displays the augmented wall. The left and middle wall are extended
and the right wall is shortened.\\

%As can be seen from the different plane colors, the building walls are changed to their individual height.

\subsection{Discussion}
We will now discuss the results. As can be seen in figure \ref{fig:outputHoughlines2d.eps} the left line segment doesn't cover the whole building wall. This is caused by using strict parameters in the Hough transform (like a small line width).
If some ascending skyline pixels fall just outside the Houghlines, a gap is created and the line segment is cut down at that point. This is however not a big problem because the lines are long enough to produce a good wall height estimate. Furthermore their are at least 5 other lines that support this estimate. These lines represent the same wall but are originated from images taken from different views. \\
The left and middle line segment of figure \ref{fig:outputHoughlines2d.eps} are a good example of the corner problem. Both endpoints could easily be associated with the wrong wall (even if the rough 3D model is very accurate). Fortunately we use the middle point of the line segment to determine the correct wall. This works well as its 100\% accurate (for this dataset).

%TODO cons pros of the flat roof assumption
%TODO vet goed dat ik dus mijn algo different wallheights aan kan, promoten!

% midpoint heuristic
\subsection{Conclusion and Future work}
We now discuss some future work and conclude.  In this thesis little is discussed about the computational costs. This is because the computations are done efficiently (e.g. using matrix multiplications in Matlab) and offline, making the calculation process done in reasonable time. To make the application real time the next speedup would be useful.\\
To find the closest wall the middle point point of the line is now projected to all walls, it could be a significant speedup to reduce the set of walls to only the walls that are found at the endpoints. The downside is that it is slightly dangerous because it could be the case that both line segments endpoints could lie on a corner point making it possible that none of the endpoints refer to the correct wall.\\

As can be seen from figure TODO%TODO
two line segments appear on the same wall. This means they have a double influence on the average wall height which is unfair. A simple solution would be to add a normalization preprocess step so each view has only one wall height vote per wall. A more elegant solution would be to merge the two (or more) line segments to a single line segment. This could be achieved with an iterative Houghline transform where the \emph{FillGap} parameter is increased in each iteration. For fig ?? %TODO 
two iterations would be enough where the \emph{FillGap} parameter needs to be at least as big as the occluding tree in the second iteration.\\
To make the algorithm more generic the flat roof assumption could be stretched or even discarded.
Consider figure TODO %TODO
it has a roof consisting of two planes which are not parallel with the facade of the building. This makes the problem of extracting the 3D model more complex but not 
infeasible. By developing a method for this it would be smart to make symmetry assumptions. The roof lies exactly in the middle of the building and it consists of two symmetric planes, this is useful information. In 
%TODO ref opzoeken
[REF] a polygon fit procedure is used where even dormers are recognized.\\

Furthermore it would be nice the fully discard the flat roof assumption. This will allow a building to have any shape, which is nice. The drawback is that a new method of outlier detection has to be developed. Object recognition could have a great deal in this. If one knows where for example an occluding object is located, then this could be used to filter the output of the skyline detector. This gives rise to a new problem that the 3D model has no augmentations at the position of occluding objects. Making sense of what would be behind the occluding object would be a interesting AI challenge and will incorporate pattern recognition, making use of repetitive structures and off course combining the multiple views to reveal as much information.\\

To conclude, we showed that a Houghline transform is a useful method to detect outliers and find prominent structure in the building contour. We introduced a heuristic to pair up line segments with their associated walls. This was used to produce new wall heights which where propagated to the 3D model.
Existing and novel AI computer vision techniques where powerful combined resulting in an accurate 3D model based on only a few calibrated 2D images. 

% TODO
%TODO what are the mathematics
%TODO write something about complications and wat je er aan hebt
%use power of illustration, lots of example images! ask myself is there stil something left where I can add an illustration??
% read again and check level of detail, is it everywhere the same?
% do I do enough chaining?
% read again on other subjects in mind see how te wr thesis

%TODO spell check!!

\end{document}
